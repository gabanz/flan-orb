description: >
  Scan ports, services and vulnerabilities and upload result to external cloud storage bucket

parameters:
  format:
    type: string
    default: "html"
    description: "The format of the report: md, html, json"
  bucket:
    type: string
    default: "flanscan"
    description: "AWS S3 bucket name to upload the results to"
  aws-access-key:
    type: string
    default: "aws-access-key"
    description: "AWS Access Key ID"
  aws-secret:
    type: string
    default: "aws-secret"
    description: "AWS Secret Access Key"

steps:
  - run:
      environment:
        BUCKET: <<parameters.bucket>>
        FORMAT: <<parameters.format>>
        AWS_ACCESS_KEY_ID: <<parameters.aws-access-key>>
        AWS_SECRET_ACCESS_KEY: <<parameters.aws-secret>>
      name: Start scanning and upload report to S3 bucket
      command: |
        docker run --name flan_scan \
        -e format=$FORMAT \
        -e upload=aws \
        -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
        -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
        -e bucket=$BUCKET \
        flan_scan
